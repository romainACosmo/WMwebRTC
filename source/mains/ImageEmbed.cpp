#include <stdio.h>
#include <opencv2/opencv.hpp>
#include "../helpers.cpp"
#include "../WM/wmV1.cpp"
#include "../WM/wmV2.cpp"
#include "../WM/wmV3.cpp"
#include "../WM/wmV4.cpp"
#include "../WM/studyDCT.cpp"

#define LENGTH 512 // 16384
#define NB_BLOCK_SELECTED 512
#define MODE 3
using namespace cv;

/**

g++ $(pkg-config --cflags --libs opencv) -std=c++11  ImageEmbed.cpp -o ImageEmbed

**/

int main(int argc, char** argv )
{

    Mat src = imread("../../lena.jpeg", 1), res, res2;
    Mat src2 = imread("../../IMG_2791.jpeg", 1);
    if ( !src.data )
    {
        printf("No image data \n");
        return -1;
    }
    if ( argc < 3 )
    {
        printf("Invalid parameters: required \"./ImageEmbed v a\" \nWhere 'v' is the embedder version and 'a' the alpha parameter\n");
        return -1;
    }
    int version = atoi(argv[1]);
    double alpha = atof(argv[2]);

    res = Mat::zeros(src.size(), CV_8UC3);

    // length = 16384
    const char wmStr[] =  "0100110001101111011100100110010101101101001000000110100101110000011100110111010101101101001000000110010001101111011011000110111101110010001000000111001101101001011101000010000001100001011011010110010101110100001011000010000001100011011011110110111001110011011001010110001101110100011001010111010001110101011100100010000001100001011001000110100101110000011010010111001101100011011010010110111001100111001000000110010101101100011010010111010000101100001000000111001101100101011001000010000001100100011011110010000001100101011010010111010101110011011011010110111101100100001000000111010001100101011011010111000001101111011100100010000001101001011011100110001101101001011001000110100101100100011101010110111001110100001000000111010101110100001000000110110001100001011000100110111101110010011001010010000001100101011101000010000001100100011011110110110001101111011100100110010100100000011011010110000101100111011011100110000100100000011000010110110001101001011100010111010101100001001011100010000001001110011010010110001001101000001000000110100101110000011100110111010101101101001000000110001101101111011011100111001101100101011100010111010101100001011101000010000001101110011010010111001101101100001000000111011001100101011011000010111000100000010101010111010000100000011100000110100001100001011100100110010101110100011100100110000100100000011100110110100101110100001000000110000101101101011001010111010000100000011000010110110001101001011100010111010101100001011011010010000001101001011001000010000001100100011010010110000101101101001011100010000001001110011001010111000101110101011001010010000001110110011011110110110001110101011101000111000001100001011101000010000001100001011000110010000001110100011010010110111001100011011010010110010001110101011011100111010000100000011101100110100101110100011000010110010100101110001000000101011001100101011011000110100101110100001000000110110001100001011011110111001001100101011001010111010000100000011010010110010000100000011001000110111101101110011001010110001100100000011101010110110001110100011100100110100101100011011001010111001100100000011101000110100101101110011000110110100101100100011101010110111001110100001000000110000101110010011000110111010100100000011011100110111101101110001011100010000001010101011101000010000001110000011010000110000101110010011001010111010001110010011000010010000001110011011010010111010000100000011000010110110101100101011101000010000001100001011011000110100101110001011101010110000101101101001000000110100101100100001000000110010001101001011000010110110100101110001000000101010101101100011011000110000101101101011000110110111101110010011100000110010101110010001000000110010101100111011001010111010000100000011011100111010101101100011011000110000100100000011001100110000101100011011010010110110001101001011100110110100100100000011001010111010001101001011000010110110100100000011001000110100101100111011011100110100101110011011100110110100101101101001011100010000001010110011001010110110000100000011001010111001001101111011100110010000001100100011011110110111001100101011000110010000001100001011000110010000001101111011001000110100101101111001000000111010001100101011011010111000001101111011100100010111000100000010011000110111101100010011011110111001001110100011010010111001100100000011001100110010101110101011001110110100101100001011101000010000001110110011010010111011001100001011011010111010101110011001000000110000101110100001000000110000101110101011001110111010101100101001000000110010101100111011001010111010000100000011000010111001001100011011101010010000001100100011010010110001101110100011101010110110100101110001000000100100101101110001000000110100001100001011000110010000001101000011000010110001001101001011101000110000101110011011100110110010100100000011100000110110001100001011101000110010101100001001000000110010001101001011000110111010001110101011011010111001101110100001000000111011001100101011100110111010001101001011000100111010101101100011101010110110100100000011100100110100001101111011011100110001101110101011100110010111000100000010000010110110001101001011100010111010101100101011101000010000001101100011001010110001101110100011101010111001100100000011100000111001001101111011010010110111000100000011011100110100101100010011010000010000001101110011010010111001101101100001000000110001101101111011011100110010001101001011011010110010101101110011101000111010101101101001000000110100101100100001000000111011001100101011011100110010101101110011000010111010001101001011100110010111000100000010101000110010101101101011100000110111101110010001000000110100101100100001000000110010101110101001000000110111001101001011100110110110000100000011011100111010101101110011000110010000001101101011010010010000001101001011100000111001101110101011011010010000001100110011000010111010101100011011010010110001001110101011100110010000001110110011010010111010001100001011001010010000001100001011011000110100101110001011101010110010101110100001011100010000001010100011101010111001001110000011010010111001100100000011000110111010101110010011100110111010101110011001000000110100101101110001000000110100001100001011000110010000001101000011000010110001001101001011101000110000101110011011100110110010100101110001000000100110101100001011001010110001101100101011011100110000101110011001000000111011001101111011011000111010101110100011100000110000101110100001000000110001001101100011000010110111001100100011010010111010000100000011000010110110001101001011100010111010101100001011011010010000001100101011101000110100101100001011011010010000001100101011100100110000101110100001000000111011001100101011011000110100101110100001000000111001101100011011001010110110001100101011100100110100101110011011100010111010101100101001000000110100101101110001011100010000001001101011000010110110001100101011100110111010101100001011001000110000100100000011100000111001001101111011010010110111000100000011011000110100101100010011001010111001001101111001000000110111001110101011011100110001100100000011000110110111101101110011100110110010101110001011101010110000101110100001000000110100101101110011101000110010101110010011001000111010101101101001011100010000001000110011001010111001001101101011001010110111001110100011101010110110100100000011100000110111101110011011101010110010101110010011001010010000001110101011100100110111001100001001000000110111001100101011000110010000001110100011010010110111001100011011010010110010001110101011011100111010000100000011100000111001001100001011001010111001101100101011011100111010000100000011100110110010101101101011100000110010101110010001000000110011001100101011101010110011101101001011000010111010000100000011011100110100101100010011010000010111000100000010101000111001001101001011100110111010001101001011100010111010101100101001000000111001101100101011011100110010101100011011101000111010101110011001000000110010101110100001000000110111001100101011101000111010101110011001000000110010101110100001000000110110101100001011011000110010101110011011101010110000101100100011000010010000001100110011000010110110101100101011100110010000001100001011000110010111001010000011100100110010101110100011010010111010101101101001000000110000101100101011011100110010101100001011011100010000001110000011010000110000101110010011001010111010001110010011000010010000001101101011000010110011101101110011000010010000001100001011000110010000001110000011011000110000101100011011001010111001001100001011101000010000001110110011001010111001101110100011010010110001001110101011011000111010101101101001011100010000001001101011000010110011101101110011000010010000001100110011001010111001001101101011001010110111001110100011101010110110100100000011010010110000101100011011101010110110001101001011100110010000001100101011101010010000001101110011011110110111000100000011001000110100101100001011011010010000001110000011010000110000101110011011001010110110001101100011101010111001100100000011101100110010101110011011101000110100101100010011101010110110001110101011011010010000001101100011011110111001001100101011011010010111000100000010011100110010101110001011101010110010100100000011100110110111101100100011000010110110001100101011100110010000001110101011101000010000001100101011101000110100101100001011011010010000001110011011010010111010000100000011000010110110101100101011101000010000001101110011010010111001101101100001000000111000001110101011100100111010101110011001000000110100101101110001000000110110101101111011011000110110001101001011100110010111000100000010001010111010100100000011011100110100101110011011011000010000001101110011101010110111001100011001000000110110101101001001000000110100101110000011100110111010101101101001000000110011001100001011101010110001101101001011000100111010101110011001011100010000001001110011101010110110001101100011000010010000001100001011011000110100101110001011101010110010101110100001000000111000001101111011100100111010001110100011010010111010001101111011100100010000001101100011000010110001101110101011100110010000001101100011101010110001101110100011101010111001100100000011000010110001101100011011101010110110101110011011000010110111000100000011101000110111101110010011101000110111101110010001000000111000001101111011100110111010101100101011100100110010100100000011000010110001100100000011101010111010000101110001000000101001101100011011001010110110001100101011100100110100101110011011100010111010101100101001000000110110101100001011101010111001001101001011100110010000001110000011001010110110001101100011001010110111001110100011001010111001101110001011101010110010100100000011100000111010101101100011101100110100101101110011000010111001000100000011100000110010101101100011011000110010101101110011101000110010101110011011100010111010101100101001000000110100001100001011000100110100101110100011000010110111001110100001000000110110101101111011100100110001001101001001000000111010001110010011010010111001101110100011010010111000101110101011001010010000001110011011001010110111001100101011000110111010001110101011100110010111000100000010011100110111101101110001000000110001001101100011000010110111001100100011010010111010000100000011011010110000101110011011100110110000100100000011001010110111001101001011011010010000001101110011001010110001100100000011001000111010101101001001000000110111001110101011011100110001100100000011011010110000101110100011101000110100101110011001000000110010101101110011010010110110100101110001000000100110001100101011000110111010001110101011100110010000001101101011000010110011101101110011000010010000001100110011100100110100101101110011001110110100101101100011011000110000100100000011101010111001001101110011000010010000001110000011011110111001001110100011101000110100101110100011011110111001000100000011100100110100001101111011011100110001101110101011100110010000001100100011011110110110001101111011100100010000001110000011101010111001001110101011100110010111000100000010011100110000101110011011000110110010101110100011101010111001000100000011100100110100101100100011010010110001101110101011011000111010101110011001000000110110101110101011100110010000001101101011000010111010101110010011010010111001100100000011101100110100101110100011000010110010100100000011101010110110001110100011100100110100101100011011010010110010101110011001011100010000001010011011010010111010000100000011000010110110101100101011101000010000001100011011011110110111001110011011001010110001101110100011001010111010001110101011100100010000001100001011001000110100101110000011010010111001101100011011010010110111001100111001000000110010101101100011010010111010000100000011001000111010101101001011100110010000001110100011100100110100101110011011101000110100101110001011101010110010100101110010011000110111101110010011001010110110100100000011010010111000001110011011101010110110100100000011001000110111101101100011011110111001000100000011100110110100101110100001000000110000101101101011001010111010000101100001000000110001101101111011011100111001101100101011000110111010001100101011101000111010101110010001000000110000101100100011010010111000001101001011100110110001101101001011011100110011100100000011001010110110001101001011101000010110000100000011100110110010101100100001000000110010001101111001000000110010101101001011101010111001101101101011011110110010000100000011101000110010101101101011100000110111101110010001000000110100101101110011000110110100101100100011010010110010001110101011011100111010000100000011101010111010000100000011011000110000101100010011011110111001001100101001000000110010101110100001000000110010001101111011011000110111101110010011001010010000001101101011000010110011101101110011000010010000001100001011011000110100101110001011101010110000100101110001000000100111001101001011000100110100000100000011010010111000001110011011101010110110100100000011000110110111101101110011100110110010101110001011101010110000101110100001000000110111001101001011100110110110000100000011101100110010101101100001011100010000001010101011101000010000001110000011010000110000101110010011001010111010001110010011000010010000001110011011010010111010000100000011000010110110101100101011101000010000001100001011011000110100101110001011101010110000101101101001000000110100101100100001000000110010001101001011000010110110100101110001000000100111001100101011100010111010101100101001000000111011001101111011011000111010101110100011100000110000101110100001000000110000101100011001000000111010001101001011011100110001101101001011001000111010101101110011101000010000001110110011010010111010001100001011001010010111000100000010101100110010101101100011010010111010000100000011011000110000101101111011100100110010101100101011101000010000001101001011001000010000001100100011011110110111001100101011000110010000001110101011011000111010001110010011010010110001101100101011100110010000001110100011010010110111001100011011010010110010001110101011011100111010000100000011000010111001001100011011101010010000001101110011011110110111000101110001000000101010101110100001000000111000001101000011000010111001001100101011101000111001001100001001000000111001101101001011101000010000001100001011011010110010101110100001000000110000101101100011010010111000101110101011000010110110100100000011010010110010000100000011001000110100101100001011011010010111000100000010101010110110001101100011000010110110101100011011011110111001001110000011001010111001000100000011001010110011101100101011101000010000001101110011101010110110001101100011000010010000001100110011000010110001101101001011011000110100101110011011010010010000001100101011101000110100101100001011011010010000001100100011010010110011101101110011010010111001101110011011010010110110100101110001000000101011001100101011011000010000001100101011100100110111101110011001000000110010001101111011011100110010101100011001000000110000101100011001000000110111101100100011010010110111100100000011101000110010101101101011100000110111101110010001011100010000001001100011011110110001001101111011100100111010001101001011100110010000001100110011001010111010101100111011010010110000101110100001000000111011001101001011101100110000101101101011101010111001100100000011000010111010000100000011000010111010101100111011101010110010100100000011001010110011101100101011101000010000001100001011100100110001101110101001000000110010001101001011000110111010001110101011011010010111000100000010010010110111000100000011010000110000101100011001000000110100001100001011000100110100101110100011000010111001101110011011001010010000001110000011011000110000101110100011001010110000100100000011001000110100101100011011101000111010101101101011100110111010000100000011101100110010101110011011101000110100101100010011101010110110001110101011011010010000001110010011010000110111101101110011000110111010101110011001011100010000001000001011011000110100101110001011101010110010101110100001000000110110001100101011000110111010001110101011100110010000001110000011100100110111101101001011011100010000001101110011010010110001001101000001000000110111001101001011100110110110000100000011000110110111101101110011001000110100101101101011001010110111001110100011101010110110100100000011010010110010000100000011101100110010101101110011001010110111001100001011101000110100101110011001011100010000001010100011001010110110101110000011011110111001000100000011010010110010000100000011001010111010100100000011011100110100101110011011011000010000001101110011101010110111001100011001000000110110101101001001000000110100101110000011100110111010101101101001000000110011001100001011101010110001101101001011000100111010101110011";

    // length = 512
    const char wmStr2[] = "00110010001111000000100000011111100011111011000000110011111100010001101000101110000100000101110101010001000000010101100101111100100111100001001100100101111111100000000101001001111100101000000110001000000101010010001101101001110111000011110111101011011011111000111110010011100011110001011000001101011101110110100101101101011010011000110010001110110110001111001101011010000101101111011101100010011011110101010101001111111111011010101101011100111100000110011110000001101101101110010100100001010001000000001010001110";

    int wmInt[LENGTH] = {0};
    str2Array(wmStr2, LENGTH, wmInt);
    int buffer[LENGTH] = {0};
    for (size_t i = 0; i < LENGTH; i++)
      buffer[i] = 1-wmInt[i];

    // wmV1(src, wmInt, LENGTH, res);
    int count = 0;
    std::cout << "Alpha,Embedding Time,PSNR" << std::endl;

    while(count < 5){
      // Mat bgr1[3], bgr2[3];
      // split(src,bgr1);
      // Mat tmp1 = bgr1[0](Rect(0, 16, 8, 8));

      // tmp1.convertTo(tmp1,CV_32FC1);
      //
      // dct(tmp1, tmp1);
      //
      std::cout << count << ",";

      switch (version) {
        case 1:
          wmV1(src, wmInt, LENGTH, res, count);
          break;
        case 2:
          wmV2(src, wmInt, LENGTH, res, count);
          break;
        case 3:
          wmV3(src, wmInt, LENGTH, res, count);
          break;
        case 4:
          if(count != 2)
            wmV4(src, count < 2 ? wmInt : buffer , LENGTH, res, 8);
          break;
        default:
          wmV1(src, wmInt, LENGTH, res, count);
          break;
      }

      // Mat bgr1[3], bgr2[3];
      // split(res,bgr1);
      // std::cout << bgr1[0](Rect(0, 18, 8, 8)) << std::endl;

      int wmRes[LENGTH] = {0};
      // exV1(src, wmRes, LENGTH);
      // int resXor[LENGTH] = {0};
      // myXor(wmInt, wmRes, LENGTH, resXor);

      // split(res,bgr2);
      // Mat tmp2 = bgr2[0](Rect(0, 16, 8, 8));
      // tmp2.convertTo(tmp2,CV_32FC1);
      // dct(tmp2, tmp2);
      // std::cout << std::endl << tmp2 << std::endl;

      std::cout << getPSNR(src, res) << std::endl;
      std::stringstream ss;
      ss << "../../figures/version" << version << "/zalpha8_" << count <<".jpg";
      imwrite(ss.str(), res);
      count+=1;
    }
    // studyDCT(src, res, MODE, NB_BLOCK_SELECTED);
    // studyDCT(src2, res2, MODE, NB_BLOCK_SELECTED);


    imshow("Original", src);

    // Mat bgr1[3], bgr2[3];
    // split(res,bgr1);
    // split(src2,bgr2);
    // // waitKey(0);
    // Mat dctTmp = bgr1[0](Rect(424, 424, 16, 16));
    // Mat dctTmp2 = bgr2[0](Rect(424, 424, 16, 16));
    // dctTmp.convertTo(dctTmp,CV_32FC1);
    // dctTmp2.convertTo(dctTmp2,CV_32FC1);
    //
    // res2 = Mat::zeros(dctTmp.size(), CV_32FC1);
    //
    // dct(dctTmp, dctTmp);
    // dct(dctTmp2, dctTmp2);
    //
    // absdiff(dctTmp, dctTmp2, res2);
    // std::cout << endl << dctTmp << std::endl;
    // std::cout << endl << dctTmp2 << std::endl;
    // std::cout << endl << res2 << std::endl;
    //
    //
    // idct(dctTmp, dctTmp);
    // idct(dctTmp2, dctTmp2);
    //
    // dctTmp.convertTo(dctTmp,CV_8UC1);
    // dctTmp2.convertTo(dctTmp2,CV_8UC1);



    // std::cout << endl << res2(Rect(424, 424, 16, 16)) << std::endl;

    imshow("Watermarked full", res);
    // exV1(res, wmRes, LENGTH);
    // int resXor[LENGTH] = {0};
    // myXor(wmInt, wmRes, LENGTH, resXor);
    // std::cout << "Hamming distance: "<< count1(resXor,LENGTH) << std::endl;

    // imshow("Diff full", res2);

    // imshow("Watermarked blue", bgr1[0]);
    // waitKey(0);

    // imshow("Watermarked block blue", bgr1[0](Rect(424, 424, 16, 16)));
    // waitKey(0);
    // imshow("Photo blue", bgr2[0]);

    // imshow("Photo block blue", bgr2[0](Rect(424, 424, 16, 16)));
    // waitKey(0);



    // exV1(res, wmRes, LENGTH);
    // exV3(src2, wmRes, LENGTH);
    // int resXor[LENGTH] = {0};
    // myXor(wmInt, wmRes, LENGTH, resXor);
    // std::cout << "Hamming distance: "<< count1(resXor,LENGTH) << std::endl;
    return 0;
}
